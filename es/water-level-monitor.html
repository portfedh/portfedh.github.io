<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Cómo crear un monitor de nivel de agua IoT | Pablo Cruz</title>
    <!-- Primary Meta Tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Favicon -->
    <link rel="icon" href="../images/terminal-solid.png" type="image/png" />

    <!-- Open Graph Tags -->
    <meta
      property="og:title"
      content="Cómo crear un monitor de nivel de agua IoT"
    />
    <meta
      property="og:description"
      content="Este artículo explica cómo construí un monitor de nivel de agua IoT usando una Raspberry Pi, un ESP32 o ESP8266 y un sensor ultrasónico."
    />
    <meta
      property="og:image"
      content="https://pablocruz.io/images/water-level-monitor/water_level_featured.png"
    />
    <meta
      property="og:url"
      content="https://pablocruz.io/water-level-monitor.html"
    />
    <meta property="og:type" content="article" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Cómo crear un monitor de nivel de agua IoT"
    />
    <meta
      name="twitter:description"
      content="Este artículo explica cómo construí un monitor de nivel de agua IoT usando una Raspberry Pi, un ESP32 o ESP8266 y un sensor ultrasónico."
    />
    <meta
      name="twitter:image"
      content="https://pablocruz.io/images/water-level-monitor/water_level_featured.png"
    />

    <!-- Stylesheets-->
    <link rel="stylesheet" href="../assets/css/custom.css" />
    <link rel="stylesheet" href="../assets/css/main.css" />
    <link rel="stylesheet" href="../assets/css/blog.css" />

    <!-- Prism.js CSS for syntax highlighting -->
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css"
      rel="stylesheet"
    />

    <!-- Hero Background Image -->
    <link
      rel="preload"
      as="image"
      href="../images/water-level-monitor/water_level_featured.png"
    />
    <noscript
      ><link rel="stylesheet" href="../assets/css/noscript.css"
    /></noscript>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-LDNFBEYMLD"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-LDNFBEYMLD");
    </script>
  </head>

  <body class="is-preload">
    <!-- Header Start-->
    <header id="header" class="blog-header">
      <!-- Language Switcher -->
      <div class="language-switcher">
        <a href="../water-level-monitor.html" class="lang-btn" aria-label="Switch to English">EN</a>
        <span class="lang-separator">|</span>
        <a href="water-level-monitor.html" class="lang-btn active" aria-label="Cambiar a Español">ES</a>
      </div>
      <div class="inner">
        <div class="blog-nav">
          <a href="../index.html" class="button" >← Volver al Portafolio</a>
        </div>
        <div class="blog-title-container">
          <h1 >Cómo crear un monitor de nivel de agua IoT</h1>
          <p class="blog-description" >Este artículo explica cómo construí un monitor de nivel de agua IoT usando una Raspberry Pi, un ESP32 o ESP8266 y un sensor ultrasónico.</p>
        </div>
      </div>
    </header>
    <!-- Header End-->

    <!-- Main Content Start -->
    <main>
      <!-- Featured Image Section -->
      <section id="featured-image" class="main style1">
        <div class="container">
          <article>
            <div class="blog-featured-image">
              <img
                src="../images/water-level-monitor/water_level_featured.png"
                alt="Summary of the water IoT water level monitor setup"
                class="image fit"
              />
            </div>
          </article>
        </div>
      </section>

      <!-- Blog Content Start -->
      <section id="blog-content" class="main style2">
        <div class="container">
          <article class="blog-post">
            <!-- Table of Contents -->
            <div class="toc-container">
              <h2 >Tabla de Contenidos</h2>
              <ul class="toc">
                <li>
                  <a href="#why-monitor" >Por qué hacer un monitor de nivel de agua</a>
                </li>
                <li>
                  <a href="#how-works" >Cómo funciona el sensor de nivel de agua</a>
                </li>
                <li>
                  <a href="#components" >Componentes del sensor de nivel de agua</a>
                </li>
                <li>
                  <a href="#build-sensor" 
                    >Cómo construir el sensor de nivel de agua</li>
                <li>
                  <a href="#reading-data" 
                    >Leyendo los datos del sensor de nivel de agua</li>
                <li>
                  <a href="#saving-data" >Guardando los valores en una base de datos</a>
                </li>
                <li><a href="#visualizing" >Visualizando los datos</a></li>
                <li><a href="#using-data" >Cómo usar los datos del sensor</a></li>
                <li><a href="#resources" >Más recursos</a></li>
                <li><a href="#code" >Código</a></li>
              </ul>
            </div>

            <!-- Introduction -->
            <div class="blog-section">
              <p >En este artículo, explicaré cómo hacer un sensor de nivel de agua con un sensor ultrasónico JSN-SR04T, un microcontrolador ESP32 y una Raspberry Pi.</p>
              <p>
                <span >Si quieres ir directo al repositorio de GitHub,</span>
                <a
                  href="https://github.com/portfedh/WaterLevelSensorMQTT"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="blog-link"
                  
                  >haz clic aquí</span>
                <a href="#code" class="blog-link" >código</a> <span >al final del artículo.</span>
              </p>
            </div>

            <div class="section-separator"></div>

            <!-- Why make a water level monitor -->
            <div class="blog-section" id="why-monitor">
              <h3 >Por qué hacer un monitor de nivel de agua</h3>
              <p >En la Ciudad de México, así como en otros países latinoamericanos, el agua generalmente se recolecta en un tanque de agua a nivel del suelo y luego se bombea a otro tanque de agua en la parte superior del edificio con una bomba de agua. La presión del agua en el hogar o negocio se obtiene por la altura del tanque de agua, en lugar de usar un tanque de compresión.</p>

              <p >El tanque de agua superior a veces puede ser difícil de alcanzar y si hay una fuga o escasez de agua, para cuando se nota, los tanques de agua pueden estar ya vacíos y necesitar atención inmediata.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_tank_diagram2.jpg"
                  alt="Diagram showing a typical setup for a house in Mexico City"
                  class="image fit"
                  style="width: 100%"
                />
                <p class="image-caption" >Diagrama que muestra una configuración típica para una casa en la Ciudad de México</p>
              </div>

              <p >Para ayudar con este problema, podemos colocar un sensor de nivel de agua en el tanque de agua superior y configurar una alerta si el nivel de agua cae por debajo del 50%.</p>
              <p >Con esta configuración podemos monitorear el tanque de forma remota, verificar la cantidad de agua que uso y recibir una alerta si hay un problema antes de que sea una emergencia.</p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- How the water level sensor works -->
            <div class="blog-section" id="how-works">
              <h3 >Cómo funciona el sensor de nivel de agua</h3>
              <p >El JSN-SR04T es un sensor ultrasónico impermeable colocado en la tapa del tanque de agua. Toma mediciones cada 5 minutos y calcula la distancia desde la tapa hasta el nivel de agua dentro del tanque. Luego transmite esa información a un microcontrolador ESP32.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_JSN-SR04T.png"
                  alt="The JSN-SR4T Waterproof ultrasonic sensor"
                  class="image fit"
                />
                <p class="image-caption" >Sensor ultrasónico impermeable JSN-SR04T</p>
              </div>
              <p >Usando Wi-Fi, el ESP32 luego envía la medición a una computadora Raspberry Pi en la misma red usando el protocolo MQTT.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_ESP3222_002.png"
                  alt="An ESP32 micro controller"
                  class="image fit"
                />
                <p class="image-caption" >Microcontrolador ESP32. También puedes usar un ESP8266.</p>
              </div>
              <p >La Raspberry Pi luego calcula el volumen de agua en el tanque y lo guarda en una base de datos Influx DB.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_raspbery_pi_002.png"
                  alt="A Raspberry Pi computer"
                  class="image fit"
                />
                <p class="image-caption" >Computadora Raspberry Pi</p>
              </div>
              <p >También en la Raspberry Pi, Grafana, un software de visualización de código abierto se usa para leer la base de datos y mostrar la información.</p>
              <p >Finalmente, se configura una alarma en Grafana, de modo que si el nivel de agua cae por debajo de un valor umbral, se activa una alarma y se envía un mensaje de Telegram para alertar a los usuarios del problema.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/Water_level_sensor_setup_002.png"
                  alt="Flow diagram of the water level monitor"
                  class="image fit"
                />
                <p class="image-caption" >Diagrama de flujo del monitor de nivel de agua</p>
              </div>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Components -->
            <div class="blog-section" id="components">
              <h3 >Componentes del sensor de nivel de agua</h3>
              <p >Para construir el sensor de nivel de agua se necesita lo siguiente:</p>

              <h4 >Hardware:</h4>
              <ul>
                <li >1 microcontrolador ESP32 o 1 microcontrolador ESP8266</li>
                <li >1 computadora Raspberry Pi</li>
                <li>
                  1
                  <a
                    href="https://geeksvalley.com/wp-content/uploads/2021/06/Waterproof-Ultrasonic-Sensor-Module.pdf"
                    target="_blank"
                    rel="noopener noreferrer"
                    >JSN-SR04T</a
                  >
                  <span >sensor ultrasónico</span>
                </li>
                <li >Un tomacorriente para el microcontrolador y el sensor</li>
                <li >Conducto eléctrico de PVC (opcional)</li>
                <li>
                  <a
                    href="https://www.printables.com/model/67422-jsn-sr04t-water-level-sensor-case"
                    target="_blank"
                    rel="noopener noreferrer"
                    
                    >Adaptador de sensor impreso en 3D (opcional)</li>
              </ul>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_3D_printed_sensor_fitting.png"
                  alt="3D Printed sensor fitting"
                  class="image fit"
                />
                <p class="image-caption" >Adaptador de sensor impreso en 3D</p>
              </div>

              <h4 >Software:</h4>
              <ul>
                <li >Una conexión WiFi</li>
                <li>
                  <a
                    href="https://randomnerdtutorials.com/how-to-install-esp8266-board-arduino-ide/"
                    target="_blank"
                    rel="noopener noreferrer"
                    
                    >Placa ESP8266</li>
                <li>
                  <a
                    href="https://www.arduino.cc/reference/en/libraries/espmqttclient/"
                    target="_blank"
                    rel="noopener noreferrer"
                    
                    >Biblioteca Arduino EspMQTTClient.h</li>
                <li>
                  <a
                    href="https://nodered.org/"
                    target="_blank"
                    rel="noopener noreferrer"
                    
                    >Node-RED</li>
                <li>
                  <a
                    href="https://mosquitto.org/"
                    target="_blank"
                    rel="noopener noreferrer"
                    
                    >Mosquitto MQTT</li>
                <li>
                  <a
                    href="https://www.influxdata.com/"
                    target="_blank"
                    rel="noopener noreferrer"
                    
                    >InfluxDB</li>
              </ul>

              <p >Elegí el sensor JSN-SR04T porque es impermeable y puede proporcionar un rango preciso de hasta 4 metros. Requiere 3V para funcionar, por lo que puede ser alimentado directamente por el microcontrolador ESP32.</p>
              <p >Para que la configuración funcione, el ESP32 debe estar dentro del alcance de tu red Wi-Fi. De esta manera puede enviar los datos del sensor a la Raspberry Pi. Además, tanto el ESP32 como la Raspberry Pi deben estar en la misma red de área local.</p>
              <p >Puedes usar un microcontrolador ESP32 o un ESP8266. Ambos funcionarán y ambos se configuran exactamente de la misma manera.</p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- How to build -->
            <div class="blog-section" id="build-sensor">
              <h3 >Cómo construir el sensor de nivel de agua</h3>

              <h4 >Conexiones</h4>
              <p >Para configurar el sensor, simplemente conecta los cables siguiendo el diagrama eléctrico a continuación:</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_diagram_002.png"
                  alt="Electrical connections diagram"
                  class="image fit"
                  style="padding: 1rem"
                />
                <p class="image-caption" >Diagrama de conexiones eléctricas</p>
              </div>

              <h4 >Caja exterior</h4>
              <p >Como esta es una configuración exterior, coloca los cables dentro de un conducto eléctrico para protegerlos de la lluvia y el sol.</p>
              <p >También necesitarás asegurarte de colocar un tomacorriente cerca para alimentar el ESP32 y el sensor.</p>
              <p >Para proteger el ESP32, parte del sensor ultrasónico y el tomacorriente, coloca todo dentro de una caja eléctrica impermeable fijada a una pared.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_electrical_box_label.png"
                  alt="Waterproof electrical box"
                  class="image fit"
                />
                <p class="image-caption" >Configuración de caja eléctrica impermeable</p>
              </div>

              <p >Dentro de la caja eléctrica, fija el ESP32 y parte del sensor usando rieles Din para mantenerlo en su lugar.</p>
              <p>
                <span >Para hacer un adaptador exacto, puedes comprar soportes de riel Din u obtener los archivos impresos en 3D y hacer el tuyo propio desde</span>
                <a
                  href="https://www.thingiverse.com/thing:4754669"
                  target="_blank"
                  rel="noopener noreferrer"
                  
                  >aquí</p>
              <p >Para configurar el sensor, perfora un agujero en la parte superior del tanque de agua. El sensor tiene accesorios de presión de silicona que deberían mantenerlo fijo en su lugar.</p>
              <p>
                <span >Puedes hacer un</span>
                <a
                  href="https://www.printables.com/model/67422-jsn-sr04t-water-level-sensor-case"
                  target="_blank"
                  rel="noopener noreferrer"
                  
                  >adaptador de tanque de agua impreso en 3D</span>
              </p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_detail.png"
                  alt="Sensor attached to lid with 3D printed fitting"
                  class="image fit"
                />
                <p class="image-caption" >Detalle de instalación del sensor</p>
              </div>

              <h4 >Mediciones utilizadas</h4>
              <p >Ahora debemos tomar las medidas del tanque de agua para calcular su volumen máximo de agua.</p>
              <p >Este tanque de agua en particular se puede separar en dos formas diferentes: un cilindro y un cono con la parte superior cortada (llamado cono truncado).</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_tank_measurements.png"
                  alt="Water tank measurements"
                  class="image fit"
                />
                <p class="image-caption" >Medidas del tanque de agua</p>
              </div>

              <p >Las fórmulas para calcular el volumen de ambas formas son:</p>

              <div class="row gtr-150">
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="../images/water-level-monitor/water_level_cylinder_formula.png"
                      alt="Formula for calculating cylinder volume"
                      class="image fit"
                    />
                    <p class="image-caption" >Fórmula del volumen del cilindro</p>
                  </div>
                </div>
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="../images/water-level-monitor/water_level_frustum_formula-e1668063602234.jpg"
                      alt="Formula for calculating frustum volume"
                      class="image fit"
                    />
                    <p class="image-caption" >Fórmula del volumen del cono truncado</p>
                  </div>
                </div>
              </div>

              <p >Usando ambas fórmulas, podemos calcular el volumen del tanque de agua de la siguiente manera:</p>
              <ul>
                <li >Volumen del cilindro: 998 Litros</li>
                <li >Volumen del cono truncado: 119 Litros</li>
                <li >Volumen total: 1,117 Litros</li>
              </ul>
              <p >En este caso, había dos tanques de agua idénticos, así que duplicamos la cantidad para obtener el volumen total máximo de agua.</p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Reading data -->
            <div class="blog-section" id="reading-data">
              <h3 >Leyendo los datos del sensor de nivel de agua</h3>
              <p >Después de tomar las medidas del tanque de agua y calcular su volumen, podemos usar el sensor para calcular la altura desde la parte superior del tanque de agua hasta la línea de agua y luego restar esa altura de las fórmulas del cono truncado y del cilindro.</p>
              <p>
                <span >Para calcular la distancia del sensor a la línea de agua usamos este</span> <a href="#code" class="blog-link" >código</a> <span >y lo cargamos al ESP32.</span>
              </p>
              <p >El código lee los datos del sensor JSN-SR04T y los envía a través de MQTT a la Raspberry Pi.</p>
              <p >Una vez cargado, abre el monitor serial de Arduino para asegurarte de que estaba funcionando correctamente.</p>
              <p >Conecta la Raspberry Pi y confirma que el Broker MQTT Mosquitto esté recibiendo los valores que el ESP32 está reportando.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_setup3.png"
                  alt="Image of the water level monitor"
                  class="image fit"
                />
                <p class="image-caption" >Configuración completa del monitor de nivel de agua</p>
              </div>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Saving data -->
            <div class="blog-section" id="saving-data">
              <h3 >Guardando los valores en una base de datos</h3>
              <p >Después de confirmar que MQTT está funcionando correctamente, necesitamos configurar Node-RED para leer los datos MQTT, guardarlos como un objeto JSON y luego escribirlos en una base de datos Influx DB que se configuró previamente.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_NodeRed.png"
                  alt="Node-RED setup in Raspberry Pi"
                  class="image fit"
                />
                <p class="image-caption" >Configuración de Node-RED en Raspberry Pi</p>
              </div>

              <ul>
                <li >El nodo 'Water Level' lee el mensaje MQTT.</li>
                <li >El nodo 'Water Level Calculation' calcula el volumen de agua teniendo en cuenta la distancia a la línea de agua.</li>
                <li >El 'Database Storage' lee la variable de volumen cada 5 minutos.</li>
                <li >El nodo 'Prepare InfluxDB Payload' agrega la fecha y hora, y guarda la salida como un objeto JSON.</li>
                <li >El nodo 'NivelTinaco_Agua' guarda la información en Influx DB en una base de datos con el mismo nombre.</li>
                <li >Los nodos verdes se usan para depuración y pruebas.</li>
              </ul>

              <p >El resto de los nodos se configuran a través del menú de nodos en Node-RED y no necesitan ningún código.</p>
              <p >Para verificar que los datos fueran accesibles, inicia sesión en la base de datos Influx DB usando la terminal y echa un vistazo a los valores.</p>

              <div class="image-container">
                <img
                  src="../images/water-level-monitor/water_level_influxdb.png"
                  alt="InfluxDB database display"
                  class="image fit"
                />
                <p class="image-caption" >Base de datos InfluxDB mostrando datos almacenados</p>
              </div>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Visualizing data -->
            <div class="blog-section" id="visualizing">
              <h3 >Visualizando los datos</h3>
              <p >Después de asegurarnos de que la información se está escribiendo correctamente en la base de datos influx DB, configuremos Grafana para visualizar los datos.</p>
              <p >Grafana es una gran herramienta para la visualización de datos porque es de código abierto, fácil de usar y produce excelentes gráficos dinámicos.</p>
              <p >Puedes hacer un tablero con una lectura de Medidor para el nivel de agua actual y también una serie temporal para mostrar los valores de agua durante un período de 24 horas.</p>

              <div class="row gtr-150">
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="../images/water-level-monitor/water_level_gauge_002.png"
                      alt="Gauge to display current water amount"
                      class="image fit"
                    />
                    <p class="image-caption" >Medidor de nivel de agua actual</p>
                  </div>
                </div>
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="../images/water-level-monitor/water_level_time_series_002.png"
                      alt="Time series showing water tank level"
                      class="image fit"
                    />
                    <p class="image-caption" >Serie temporal de nivel de agua de 24 horas</p>
                  </div>
                </div>
              </div>

              <p >En el gráfico puedes ver cómo el nivel de agua cae periódicamente (duchas matutinas, lavar ropa al mediodía) y se restaura gradualmente con el tiempo.</p>
              <p >Los niveles de agua no parecen caer por debajo de la marca de 1,000L, pero se configura una alarma para enviar un mensaje de Telegram si el nivel de agua cae por debajo de este valor umbral.</p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Using data -->
            <div class="blog-section" id="using-data">
              <h3 >Cómo usar los datos del sensor</h3>
              <p >Los datos del sensor son útiles porque verifica el nivel de agua cada 5 minutos y envía una alarma si el nivel es demasiado bajo.</p>
              <p >Nos permite saber si hay un problema, lo que nos da tiempo para solucionarlo con suficiente agua disponible para tareas esenciales.</p>
              <p >También es un sensor útil porque nos permite verificar el consumo diario de agua y cómo esa tendencia cambia con el tiempo.</p>
              <p >Medir es el primer paso hacia la eficiencia y un futuro más sostenible.</p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- More resources -->
            <div class="blog-section" id="resources">
              <h3 >Más recursos</h3>
              <p >Espero que hayas encontrado este artículo interesante. Construir el sensor de agua fue un proyecto divertido y gratificante, y lo he encontrado muy útil.</p>
              <p >Si decides construir una configuración similar de monitoreo de nivel de agua, te animo a ser creativo y ver cómo puedes personalizarla para adaptarla a tus necesidades específicas. Hay muchas variaciones y mejoras posibles que podrías hacer, como integrarlo con sistemas de hogar inteligente o expandir la red de sensores a múltiples tanques. La clave es empezar poco a poco, experimentar y no tener miedo de solucionar problemas cuando las cosas no funcionen como se esperaba.</p>
              <p >No dudes en contactarme si decides construir uno y necesitas ayuda.</p>
              <p>
                <span >También hice un Monitor de Energía IoT. Puedes encontrar el artículo sobre eso</span>
                <a
                  href="https://blog.pablocruz.io/iot-energy-monitor/"
                  target="_blank"
                  rel="noopener noreferrer"
                  
                  >aquí</p>

              <p >Finalmente, aquí hay algunos recursos adicionales que usé para hacer posible este proyecto:</p>

              <div class="video-resources">
                <div class="row gtr-150">
                  <div class="col-4 col-12-medium">
                    <div class="video-container">
                      <a href="https://www.youtube.com/watch?v=h6321UBATps" target="_blank" rel="noopener noreferrer">
                        <img src="https://img.youtube.com/vi/h6321UBATps/maxresdefault.jpg" alt="YouTube Video Thumbnail" class="video-thumbnail" />
                        <div class="play-button">▶</div>
                      </a>
                    </div>
                  </div>
                  <div class="col-4 col-12-medium">
                    <div class="video-container">
                      <a href="https://www.youtube.com/watch?v=KawRd5evHyY" target="_blank" rel="noopener noreferrer">
                        <img src="https://img.youtube.com/vi/KawRd5evHyY/maxresdefault.jpg" alt="YouTube Video Thumbnail" class="video-thumbnail" />
                        <div class="play-button">▶</div>
                      </a>
                    </div>
                  </div>
                  <div class="col-4 col-12-medium">
                    <div class="video-container">
                      <a href="https://www.youtube.com/watch?v=7M8MHa6W9w0" target="_blank" rel="noopener noreferrer">
                        <img src="https://img.youtube.com/vi/7M8MHa6W9w0/maxresdefault.jpg" alt="YouTube Video Thumbnail" class="video-thumbnail" />
                        <div class="play-button">▶</div>
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Back to table of contents"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Code section -->
            <div class="blog-section" id="code">
              <h3 >Código</h3>

              <h4 >Código Arduino cargado al ESP32:</h4>
              <pre class="code-block">
                <div class="code-header">
                  <span >C++ (Arduino)</span>
                  <button class="copy-button" onclick="copyCode(this)" >Copiar</button>
                </div>
                <code class="language-cpp">// Code to measure water level in a water tank

// Mills Function 
const unsigned long event_interval = 300000; // 5 minute interval, 300 second
//const unsigned long event_interval = 2000; // 2 second interval. For testing
unsigned long previous_time = 0; 

// MQTT Library
#include "EspMQTTClient.h" 

#define WIFI_SSID        "&lt;Wifi_Username_here&gt;"                          // WiFi Username
#define WIFI_PASS        "&lt;Wifi_Password_here&gt;"                          // Wifi Password

#define BROKER_IP        "&lt;MQTT_ip_here&gt;"                                // IP address of MQTT broker
#define BROKER_USERNAME  "&lt;broker_username_here&gt;"                        // Broker username
#define BROKER_PASSWORD  "&lt;broker_password_here&gt;"                        // Broker password
#define CLIENT_NAME      "&lt;device_name_here&gt;"                            // MQTT client name to identify the device
#define BROKER_PORT      &lt;mqtt_port_here&gt;                                // MQTT Port. No "" needed
#define lastwill_topic   "&lt;lastwill_topic_here&gt;"                         // MQTT topic to report last-will and testament.
#define lastwill_text    "&lt;lastwill_message_here&gt;"                       // MQTT message to report last-will and testament.

String  client_name       = CLIENT_NAME;                                 // MQTT Topic to report initial value
String  startup_topic     = "&lt;startup_topic_here&gt;";                      // MQTT Topic to report startup
String  water_level_topic = "&lt;reporting_values_topic_here&gt;";             // MQTT topic to report values

// Function to connect to MQTT 
EspMQTTClient client(
                  WIFI_SSID,
                  WIFI_PASS,
                  BROKER_IP,
                  BROKER_USERNAME,
                  BROKER_PASSWORD,
                  CLIENT_NAME,
                  BROKER_PORT
                  );

// Water Sensor pins
#define TRIG 14 //GPIO Number 14, D5
#define ECHO 12 //GPIO Number 12, D6

void setup() { 
  
  Serial.begin(115200); // Serial monitoring 
  
  // Enable  debugging messages sent to serial output
  client.enableDebuggingMessages(); 

  // Enable the web updater.
  client.enableHTTPWebUpdater();     
  
  // MQTT Last Will & Testament
  client.enableLastWillMessage( lastwill_topic , lastwill_text);
  
  // Water level sensor Pin Setup
  pinMode(TRIG, OUTPUT);       // Initializing Trigger Output
  pinMode(ECHO, INPUT_PULLUP); // Initializing Echo Input
  } 

// MQTT Initial Connection
void onConnectionEstablished() {
  client.publish(startup_topic, String(client_name + " is now online."));
  }
  
  void loop() { 

    // MQTT Loop: Must be called once per loop.
    client.loop(); 

    // Mills Loop
    unsigned long current_time = millis();

    // Mills if Statement
    if(current_time - previous_time &gt;= event_interval) {
      // Set the trigger pin to low for 2uS 
      digitalWrite(TRIG, LOW); 
      delayMicroseconds(2); 

      // Send a 20uS high to trigger ranging
      digitalWrite(TRIG, HIGH);  
      delayMicroseconds(20); 

      // Send pin low again
      digitalWrite(TRIG, LOW);  

      // Read pulse times
      int distance = pulseIn(ECHO, HIGH,26000);  

      //Convert the pulse duration to distance
      distance= distance/58; 

      //Print Result in serial monitor
      Serial.print("Distance ");
      Serial.print(distance);
      Serial.println("cm");

      // MQTT Client Publisher
      client.publish(water_level_topic, String(distance));

      // Mills Update timing for next time
      previous_time = current_time;
    }
    
}</code></pre>

              <h4 >Código Node-RED utilizado:</h4>

              <h5 >Nodo Water Level Calculation:</h5>
              <pre class="code-block">
                <div class="code-header">
                  <span >JavaScript (Node-RED)</span>
                  <button class="copy-button" onclick="copyCode(this)" >Copiar</button>
                </div>
                <code class="language-javascript">// Code to calculate the available water in the water tank.
// Used in node: 'Water Level Calculation'

// Get sensor distance in meters
msg.payload = Number(msg.payload)/100;
sensor_distance = msg.payload;

// Constants
var pi = 3.141592;
var Liters = 0;
var VolumeFullCylinder = 998;

// Function to calculate water in Frustum
function FrustumVolume(x) {
    height = 0.35 - x
    FrustumWaterVolume = (pi/3)*height*(0.55**2 + 0.275**2 + 0.55*0.275)
    return FrustumWaterVolume*1000
  }

// Function to calculate water in Cylinder
function CylinderVolume(x) {
    height = 1.05 - x + 0.35
    CylinderWaterVolume = pi * 0.55**2 * height
    return CylinderWaterVolume*1000
  }

// Test to check total water volume
if (sensor_distance &lt; 0.20) {
    Message = "Error: Value is too low. Check Sensor";
    Liters = 0;
    msg.payload = Liters

  } else if (sensor_distance &gt;= 0.20 &amp;&amp; sensor_distance &lt;= 0.35) {
    Message = "Water is in Frustum.";
    Liters = FrustumVolume(sensor_distance)+ VolumeFullCylinder;
    Liters = Math.round(Liters*2) // Multiply x 2 because there are 2 water tanks
    msg.payload = Liters

  } else if (sensor_distance &gt; 0.35 &amp;&amp; sensor_distance &lt;= 1.40) {
    Message = "Water is in the cylinder section.";
    Liters = CylinderVolume(sensor_distance);
    Liters = Math.round(Liters*2) // Multiply x 2 because there are 2 water tanks
    msg.payload = Liters

  } else {
    Message = "Error: Value is to high. Check Sensor";
    Liters = 9999;
    msg.payload = Liters
  }

// Prepare node to send information
msg.payload = Number(msg.payload); 
flow.set("water_in_tank",msg.payload);
flow.set("water_level_sensor","ESP32");
return {payload: msg.payload};</code></pre>

              <h5 >Nodo Prepare InfluxDB Payload:</h5>
              <pre class="code-block">
                <div class="code-header">
                  <span >JavaScript (Node-RED)</span>
                  <button class="copy-button" onclick="copyCode(this)" >Copiar</button>
                </div>
                <code class="language-javascript">// Code to prepare water level data to save it into InfluxDB
// Used in node: 'Prepare InfluxDB Payload'

var today = new Date();

var date = today.getFullYear()+
            '-'+ (today.getMonth()+1)+
            '-'+ today.getDate() + 
            ' ' + today.getHours() + 
            ":" + today.getMinutes() + 
            ":" + today.getSeconds();

msg.payload = { 
    Timestamp:date, 
    Device:flow.get("water_level_sensor"), 
    Water_Level_In_Tank:flow.get("water_in_tank"),
}

return msg;</code></pre>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Volver a la tabla de contenidos"
                ></a>
              </div>
            </div>
          </article>
        </div>
      </section>
      <!-- Blog Content End -->

      <!-- Navigation Section -->
      <section id="navigation" class="main style1">
        <div class="container">
          <article>
            <div class="blog-navigation">
              <div class="nav-links">
                <div class="nav-left">
                  <a href="../index.html" class="button white-text"
                    >← Volver al Portafolio</a>
                </div>
                <div class="nav-right">
                  <a
                    href="https://github.com/portfedh/WaterLevelSensorMQTT"
                    class="button white-text"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <i class="fab fa-github"></i> <span >Ver en GitHub</span>
                  </a>
                </div>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- Contact Start-->
      <section id="contact-section" class="main style2 special">
        <div class="container">
          <article>
            <header class="major fade-out">
              <h2 >¡Pongámonos en contacto!</h2>
            </header>
            <p class="fade-out">
              <span >Actualmente estoy abierto a trabajar y me encantaría platicar.</span>
              <br />
              <br />
              <span >No dudes en contactarme si estás interesado en lo que puedo aportar a tu proyecto o equipo.</span>
            </p>
            <ul class="actions special">
              <li>
                <a
                  href="mailto:pablo.cruz.lemini@gmail.com"
                  class="button wide primary fade-out"
                  >Envíame un correo</a>
              </li>
            </ul>
          </article>
        </div>
      </section>
      <!-- Contact End-->
    </main>
    <!-- Main Content End -->

    <!-- Footer Start -->
    <footer id="footer">
      <ul class="icons">
        <li>
          <a
            href="https://twitter.com/Portfedh"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Twitter Profile"
            ><i class="fa-brands fa-twitter"></i><span class="label">Twitter</span></a
          >
        </li>
        <li>
          <a
            href="https://www.linkedin.com/in/pablo-cruz-cdmx/"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="LinkedIn Profile"
            ><i class="fa-brands fa-linkedin"></i><span class="label">LinkedIn</span></a
          >
        </li>
        <li>
          <a
            href="https://github.com/portfedh"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="GitHub Profile"
            ><i class="fa-brands fa-github"></i><span class="label">GitHub</span></a
          >
        </li>
        <li>
          <a
            href="mailto:pablo.cruz.lemini@gmail.com"
            aria-label="Email link"
            ><i class="fa-solid fa-envelope"></i><span class="label">Email</span></a
          >
        </li>
      </ul>
      <ul class="copyright">
        <li>
          &copy;
          <script>
            document.write(new Date().getFullYear());
          </script>
          Pablo Cruz.
        </li>
      </ul>
    </footer>
    <!-- Footer End -->

    <!-- Scripts -->
    <script src="../assets/js/main.js"></script>
    <script
      src="https://kit.fontawesome.com/1450436a40.js"
      crossorigin="anonymous"
    ></script>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Blog functionality -->
    <script src="../assets/js/blog.js"></script>
  </body>
</html>
