{
  "meta": {
    "title": "How to make an IoT water level monitor | Pablo Cruz",
    "ogTitle": "How to make an IoT water level monitor",
    "description": "This post explains how I made an IoT water level monitor using a raspberry pi, an ESP32 or ESP8266 and an ultrasonic sensor."
  },
  "header": {
    "backButton": "← Back to Portfolio",
    "title": "How to make an IoT water level monitor",
    "description": "This post explains how I made an IoT water level monitor using a raspberry pi, an ESP32 or ESP8266 and an ultrasonic sensor."
  },
  "toc": {
    "heading": "Table of Contents",
    "whyMonitor": "Why make a water level monitor",
    "howWorks": "How the water level sensor works",
    "components": "Components of the water level sensor",
    "buildSensor": "How to build the water level sensor",
    "readingData": "Reading the water level sensor data",
    "savingData": "Saving the values to a database",
    "visualizing": "Visualizing the data",
    "usingData": "How to use the sensor data",
    "resources": "More resources",
    "code": "Code"
  },
  "intro": {
    "paragraph1": "In this post, I'll explain how to make a water level sensor with a JSN-SR04T ultrasonic sensor, an ESP32 micro controller and a Raspberry Pi.",
    "paragraph2": "If you want to jump to the GitHub repository,",
    "clickHere": "click here",
    "paragraph3": ". You can also find a copy of the",
    "codeLink": "code",
    "paragraph4": "at the end of the post."
  },
  "whyMonitor": {
    "heading": "Why make a water level monitor",
    "paragraph1": "In Mexico City, as well as other Latin American countries, water is usually collected in a water tank at ground level and then pumped to another water tank at the top of the building with a water pump. Water pressure at the home or business is obtained by the height of the water tank, instead of using a compression tank.",
    "paragraph2": "The top water tank can sometimes be hard to reach and If there's a leak or a water shortage, by the time its noticed the water tanks may already be empty and need immediate attention.",
    "imageCaption": "Diagram showing a typical setup for a house in Mexico City",
    "paragraph3": "To help with this problem we can place a water level sensor in the top water tank and set an alert if the water level falls below 50%.",
    "paragraph4": "With this setup we can monitor the tank remotely, check the amount of water I use and get an alert if there's a problem before it's an emergency."
  },
  "howWorks": {
    "heading": "How the water level sensor works",
    "paragraph1": "The JSN-SR04T is a waterproof ultrasonic sensor placed in the lid of the water tank. It takes measurements every 5 minutes and calculates the distance from the lid to the water level inside the tank. It then transmits that information to an ESP32 micro controller.",
    "imageCaption1": "JSN-SR04T Waterproof ultrasonic sensor",
    "paragraph2": "Using Wi-Fi, the ESP32 then sends the measurement to a Raspberry-Pi computer in the same network using the MQTT protocol.",
    "imageCaption2": "ESP32 micro controller. You can also use an ESP8266.",
    "paragraph3": "The Raspberry Pi then calculates the volume of water in the tank and saves it to an Influx DB database.",
    "imageCaption3": "Raspberry Pi computer",
    "paragraph4": "Also in the Raspberry Pi, Grafana, an open-source visualization software is used to read the database and display the information.",
    "paragraph5": "Finally, an alarm is set up in Grafana, so if the water level goes below a threshold value, an alarm is triggered, and a Telegram message is sent to alert users of the problem.",
    "imageCaption4": "Flow diagram of the water level monitor"
  },
  "components": {
    "heading": "Components of the water level sensor",
    "intro": "To build the water level sensor the following is needed:",
    "hardwareHeading": "Hardware:",
    "hardware1": "1 ESP32 micro controller or 1 ESP8266 micro controller",
    "hardware2": "1 Raspberry Pi computer",
    "hardware3": "ultrasonic sensor",
    "hardware4": "A power outlet for the micro controller and sensor",
    "hardware5": "Electrical PVC conduit (optional)",
    "hardware6": "3D printed sensor fitting (optional)",
    "imageCaption": "3D Printed sensor fitting",
    "softwareHeading": "Software:",
    "software1": "A WiFi connection",
    "software2": "ESP8266 board",
    "software3": "EspMQTTClient.h Arduino library",
    "software4": "Node-RED",
    "software5": "Mosquitto MQTT",
    "software6": "InfluxDB",
    "paragraph1": "I chose the JSN-SR04T sensor because it's waterproof and can provide an accurate range up to 4 meters. It requires 3V to work so it can be powered directly by the ESP32 micro controller.",
    "paragraph2": "For the setup to work, the ESP32 must be in range of your Wi-Fi network. This way it can send the data from the sensor to the Raspberry-Pi. Also, both the ESP32 and the Raspberry Pi need to be in the same local area network.",
    "paragraph3": "You can use either an ESP32 or an ESP8266 micro controller. Both will work and both are set up in exactly the same way."
  },
  "buildSensor": {
    "heading": "How to build the water level sensor",
    "connectionsHeading": "Connections",
    "paragraph1": "To set up the sensor simply connect the wires following the electrical diagram below:",
    "imageCaption1": "Electrical connections diagram",
    "outdoorHeading": "Outdoor housing",
    "paragraph2": "Since this is an outdoor setup, place the cables inside an electrical conduit to protect them from the rain and the sun.",
    "paragraph3": "You will also need to make sure to place an electrical outlet nearby to power the ESP32 and the sensor.",
    "paragraph4": "To protect the ESP32, part of the ultrasonic sensor and the power outlet, house everything inside a waterproof electrical box attached to a wall.",
    "imageCaption2": "Waterproof electrical box setup",
    "paragraph5": "Inside the electrical box, fix the ESP32 and part of the sensor using Din rails to keep it in place.",
    "paragraph6": "To make an exact adapter, you can buy Din rail mounts or get the 3D printed files and make your own from",
    "here": "here",
    "paragraph7": "To set up the sensor, drill a hole at the top of the water tank. The sensor has silicone pressure fittings that should keep it fixed in place.",
    "paragraph8": "You can make a",
    "link3dPrinted": "3d printed water tank adapter",
    "paragraph9": "to make sure the sensor cable is protected from the elements.",
    "imageCaption3": "Sensor installation detail",
    "measurementsHeading": "Measurements used",
    "paragraph10": "Now we must take the measurements of the water tank to calculate its maximum water volume.",
    "paragraph11": "This particular water tank can be separated into two different shapes: A cylinder and a cone with its top cut off (called a frustum cone).",
    "imageCaption4": "Water tank measurements",
    "paragraph12": "The formulas to calculate the volume of both shapes are:",
    "imageCaption5": "Cylinder volume formula",
    "imageCaption6": "Frustum volume formula",
    "paragraph13": "Using both formulas, we can calculate the volume for the water tank in the following way:",
    "volume1": "Cylinder volume: 998 Liters",
    "volume2": "Frustum volume: 119 Liters",
    "volume3": "Total volume: 1,117 Liters",
    "paragraph14": "In this case, there were two identical water tanks, so we doubled the amount to get the maximum total water volume."
  },
  "readingData": {
    "heading": "Reading the water level sensor data",
    "paragraph1": "After taking the measurements of the water tank and calculating its volume, we can use the sensor to calculate the height from the top of the water tank to the water line and then subtract that height from the frustum and cylinder formulas.",
    "paragraph2": "To calculate the distance from the sensor to the water line we used this",
    "codeLink": "code",
    "paragraph3": "and uploaded it to the ESP32.",
    "paragraph4": "The code reads the JSN-SR04T sensor data and sends it through MQTT to the Raspberry Pi.",
    "paragraph5": "Once uploaded, open the Arduino serial monitor to make sure it was working correctly.",
    "paragraph6": "Connect the Raspberry Pi and confirm that the Mosquitto MQTT Broker is receiving the values that the ESP32 is reporting.",
    "imageCaption": "Complete water level monitor setup"
  },
  "savingData": {
    "heading": "Saving the values to a database",
    "paragraph1": "After confirming that MQTT is working correctly, we need to configure Node-RED to read the MQTT data, save it as as JSON object and then write it to a Influx DB database which was previously set up.",
    "imageCaption": "Node-RED setup in Raspberry Pi",
    "bullet1": "The 'Water Level' node reads the MQTT message.",
    "bullet2": "The 'Water Level Calculation' node calculates the water volume taking into account the distance to the waterline.",
    "bullet3": "The 'Database Storage' reads the volume variable every 5 minutes.",
    "bullet4": "The 'Prepare InfluxDB Payload' node adds the date and time, and saves the output as a JSON object.",
    "bullet5": "The 'NivelTinaco_Agua' node saves the information to Influx DB in a database with the same name.",
    "bullet6": "Green nodes are used for debugging and testing.",
    "paragraph2": "The rest of the nodes are configured through the node menu in Node-RED and don't need any code.",
    "paragraph3": "To check that the data was accessible, log into the Influx DB database using the terminal and take a look at the values.",
    "imageCaption2": "InfluxDB database showing stored data"
  },
  "visualizing": {
    "heading": "Visualizing the data",
    "paragraph1": "After making sure that the information is getting written into the influx DB database correctly, lets configure Grafana to visualize the data.",
    "paragraph2": "Grafana is a great tool for data visualization because its open source, easy to use, and produces great dynamic charts.",
    "paragraph3": "You can make a dashboard with a Gauge reading for the current water level and also a time series to display the water values over a 24-hour period.",
    "imageCaption1": "Current water level gauge",
    "imageCaption2": "24-hour water level time series",
    "paragraph4": "In the graph you can see how the water level falls periodically (morning showers, washing clothes at midday) and is gradually restored over time.",
    "paragraph5": "Water levels don't seem to fall below the 1,000L mark, but an alarm is set to send a telegram message if the water level falls below this threshold value."
  },
  "usingData": {
    "heading": "How to use the sensor data",
    "paragraph1": "The sensor data is useful because it checks the water level every 5 minutes and sends an alarm if the level is too low.",
    "paragraph2": "It lets us know if there's a problem, which gives us time to fix it with enough water available for essential tasks.",
    "paragraph3": "It is also a useful sensor because it allows us to check the daily water consumption and how that trend changes over time.",
    "paragraph4": "Measuring is the first step towards efficiency and a more sustainable future."
  },
  "resources": {
    "heading": "More resources",
    "paragraph1": "I hope you found this post interesting. Building the water sensor was a fun and rewarding project, and I've found it to be a very useful project.",
    "paragraph2": "If you decide to build a similar water level monitoring setup, I encourage you to get creative and see how you can customize it to fit your specific needs. There are many possible variations and improvements you could make, like integrating it with smart home systems or expanding the sensor network to multiple tanks. The key is to start small, experiment, and don't be afraid to troubleshoot when things don't work as expected.",
    "paragraph3": "Feel free to contact me if you decide to build one and you need any help.",
    "paragraph4": "I also made IoT Energy Monitor. You can find the post about that",
    "here": "here",
    "paragraph5": "Finally, here are some additional resources that I used to make this project possible:"
  },
  "code": {
    "heading": "Code",
    "arduinoHeading": "Arduino code uploaded to the ESP32:",
    "nodeRedHeading": "Node-RED Code used:",
    "waterLevelCalc": "Water Level Calculation node:",
    "influxPayload": "Prepare InfluxDB Payload node:",
    "copyButton": "Copy",
    "cppLabel": "C++ (Arduino)",
    "jsLabel": "JavaScript (Node-RED)"
  },
  "navigation": {
    "backToPortfolio": "← Back to Portfolio",
    "viewGithub": "View on GitHub",
    "backToTop": "Back to table of contents"
  },
  "contact": {
    "heading": "Get in touch!",
    "paragraph1": "I'm currently open to work and I'd be happy to chat.",
    "paragraph2": "Feel free to reach out if you are interested in what I can bring to your project or team.",
    "emailButton": "Email me"
  }
}
