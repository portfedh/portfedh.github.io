<!DOCTYPE html>
<html lang="en">
  <head>
    <title>How to make an IoT water level monitor | Pablo Cruz</title>
    <!-- Primary Meta Tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Favicon -->
    <link rel="icon" href="images/terminal-solid.png" type="image/png" />

    <!-- Open Graph Tags -->
    <meta
      property="og:title"
      content="How to make an IoT water level monitor"
    />
    <meta
      property="og:description"
      content="This post explains how I made an IoT water level monitor using a raspberry pi, an ESP32 or ESP8266 and an ultrasonic sensor."
    />
    <meta
      property="og:image"
      content="https://pablocruz.io/images/water-level-monitor/water_level_featured.png"
    />
    <meta
      property="og:url"
      content="https://pablocruz.io/water-level-monitor.html"
    />
    <meta property="og:type" content="article" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="How to make an IoT water level monitor"
    />
    <meta
      name="twitter:description"
      content="This post explains how I made an IoT water level monitor using a raspberry pi, an ESP32 or ESP8266 and an ultrasonic sensor."
    />
    <meta
      name="twitter:image"
      content="https://pablocruz.io/images/water-level-monitor/water_level_featured.png"
    />

    <!-- Stylesheets-->
    <link rel="stylesheet" href="assets/css/custom.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/blog.css" />

    <!-- Prism.js CSS for syntax highlighting -->
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css"
      rel="stylesheet"
    />

    <!-- Hero Background Image -->
    <link
      rel="preload"
      as="image"
      href="/images/water-level-monitor/water_level_featured.png"
    />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-LDNFBEYMLD"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-LDNFBEYMLD");
    </script>
  </head>

  <body class="is-preload">
    <!-- Header Start-->
    <header id="header" class="blog-header">
      <!-- Language Switcher -->
      <div class="language-switcher">
        <button class="lang-btn" data-lang="en" aria-label="Switch to English">EN</button>
        <span class="lang-separator">|</span>
        <button class="lang-btn" data-lang="es" aria-label="Cambiar a Español">ES</button>
      </div>
      <div class="inner">
        <div class="blog-nav">
          <a href="index.html" class="button" data-i18n="header.backButton">← Back to Portfolio</a>
        </div>
        <div class="blog-title-container">
          <h1 data-i18n="header.title">How to make an IoT water level monitor</h1>
          <p class="blog-description" data-i18n="header.description">
            This post explains how I made an IoT water level monitor using a
            raspberry pi, an ESP32 or ESP8266 and an ultrasonic sensor.
          </p>
        </div>
      </div>
    </header>
    <!-- Header End-->

    <!-- Main Content Start -->
    <main>
      <!-- Featured Image Section -->
      <section id="featured-image" class="main style1">
        <div class="container">
          <article>
            <div class="blog-featured-image">
              <img
                src="images/water-level-monitor/water_level_featured.png"
                alt="Summary of the water IoT water level monitor setup"
                class="image fit"
              />
            </div>
          </article>
        </div>
      </section>

      <!-- Blog Content Start -->
      <section id="blog-content" class="main style2">
        <div class="container">
          <article class="blog-post">
            <!-- Table of Contents -->
            <div class="toc-container">
              <h2 data-i18n="toc.heading">Table of Contents</h2>
              <ul class="toc">
                <li>
                  <a href="#why-monitor" data-i18n="toc.whyMonitor">Why make a water level monitor</a>
                </li>
                <li>
                  <a href="#how-works" data-i18n="toc.howWorks">How the water level sensor works</a>
                </li>
                <li>
                  <a href="#components" data-i18n="toc.components">Components of the water level sensor</a>
                </li>
                <li>
                  <a href="#build-sensor" data-i18n="toc.buildSensor"
                    >How to build the water level sensor</a
                  >
                </li>
                <li>
                  <a href="#reading-data" data-i18n="toc.readingData"
                    >Reading the water level sensor data</a
                  >
                </li>
                <li>
                  <a href="#saving-data" data-i18n="toc.savingData">Saving the values to a database</a>
                </li>
                <li><a href="#visualizing" data-i18n="toc.visualizing">Visualizing the data</a></li>
                <li><a href="#using-data" data-i18n="toc.usingData">How to use the sensor data</a></li>
                <li><a href="#resources" data-i18n="toc.resources">More resources</a></li>
                <li><a href="#code" data-i18n="toc.code">Code</a></li>
              </ul>
            </div>

            <!-- Introduction -->
            <div class="blog-section">
              <p data-i18n="intro.paragraph1">
                In this post, I'll explain how to make a water level sensor with
                a JSN-SR04T ultrasonic sensor, an ESP32 micro controller and a
                Raspberry Pi.
              </p>
              <p>
                <span data-i18n="intro.paragraph2">If you want to jump to the GitHub repository,</span>
                <a
                  href="https://github.com/portfedh/WaterLevelSensorMQTT"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="blog-link"
                  data-i18n="intro.clickHere"
                  >click here</a
                ><span data-i18n="intro.paragraph3">. You can also find a copy of the</span>
                <a href="#code" class="blog-link" data-i18n="intro.codeLink">code</a> <span data-i18n="intro.paragraph4">at the end of the
                post.</span>
              </p>
            </div>

            <div class="section-separator"></div>

            <!-- Why make a water level monitor -->
            <div class="blog-section" id="why-monitor">
              <h3 data-i18n="whyMonitor.heading">Why make a water level monitor</h3>
              <p data-i18n="whyMonitor.paragraph1">
                In Mexico City, as well as other Latin American countries, water
                is usually collected in a water tank at ground level and then
                pumped to another water tank at the top of the building with a
                water pump. Water pressure at the home or business is obtained
                by the height of the water tank, instead of using a compression
                tank.
              </p>

              <p data-i18n="whyMonitor.paragraph2">
                The top water tank can sometimes be hard to reach and If there's
                a leak or a water shortage, by the time its noticed the water
                tanks may already be empty and need immediate attention.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_tank_diagram2.jpg"
                  alt="Diagram showing a typical setup for a house in Mexico City"
                  class="image fit"
                  style="width: 100%"
                />
                <p class="image-caption" data-i18n="whyMonitor.imageCaption">
                  Diagram showing a typical setup for a house in Mexico City
                </p>
              </div>

              <p data-i18n="whyMonitor.paragraph3">
                To help with this problem we can place a water level sensor in
                the top water tank and set an alert if the water level falls
                below 50%.
              </p>
              <p data-i18n="whyMonitor.paragraph4">
                With this setup we can monitor the tank remotely, check the
                amount of water I use and get an alert if there's a problem
                before it's an emergency.
              </p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- How the water level sensor works -->
            <div class="blog-section" id="how-works">
              <h3 data-i18n="howWorks.heading">How the water level sensor works</h3>
              <p data-i18n="howWorks.paragraph1">
                The JSN-SR04T is a waterproof ultrasonic sensor placed in the
                lid of the water tank. It takes measurements every 5 minutes and
                calculates the distance from the lid to the water level inside
                the tank. It then transmits that information to an ESP32 micro
                controller.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_JSN-SR04T.png"
                  alt="The JSN-SR4T Waterproof ultrasonic sensor"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="howWorks.imageCaption1">
                  JSN-SR04T Waterproof ultrasonic sensor
                </p>
              </div>
              <p data-i18n="howWorks.paragraph2">
                Using Wi-Fi, the ESP32 then sends the measurement to a
                Raspberry-Pi computer in the same network using the MQTT
                protocol.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_ESP3222_002.png"
                  alt="An ESP32 micro controller"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="howWorks.imageCaption2">
                  ESP32 micro controller. You can also use an ESP8266.
                </p>
              </div>
              <p data-i18n="howWorks.paragraph3">
                The Raspberry Pi then calculates the volume of water in the tank
                and saves it to an Influx DB database.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_raspbery_pi_002.png"
                  alt="A Raspberry Pi computer"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="howWorks.imageCaption3">Raspberry Pi computer</p>
              </div>
              <p data-i18n="howWorks.paragraph4">
                Also in the Raspberry Pi, Grafana, an open-source visualization
                software is used to read the database and display the
                information.
              </p>
              <p data-i18n="howWorks.paragraph5">
                Finally, an alarm is set up in Grafana, so if the water level
                goes below a threshold value, an alarm is triggered, and a
                Telegram message is sent to alert users of the problem.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/Water_level_sensor_setup_002.png"
                  alt="Flow diagram of the water level monitor"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="howWorks.imageCaption4">
                  Flow diagram of the water level monitor
                </p>
              </div>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Components -->
            <div class="blog-section" id="components">
              <h3 data-i18n="components.heading">Components of the water level sensor</h3>
              <p data-i18n="components.intro">To build the water level sensor the following is needed:</p>

              <h4 data-i18n="components.hardwareHeading">Hardware:</h4>
              <ul>
                <li data-i18n="components.hardware1">1 ESP32 micro controller or 1 ESP8266 micro controller</li>
                <li data-i18n="components.hardware2">1 Raspberry Pi computer</li>
                <li>
                  1
                  <a
                    href="https://geeksvalley.com/wp-content/uploads/2021/06/Waterproof-Ultrasonic-Sensor-Module.pdf"
                    target="_blank"
                    rel="noopener noreferrer"
                    >JSN-SR04T</a
                  >
                  <span data-i18n="components.hardware3">ultrasonic sensor</span>
                </li>
                <li data-i18n="components.hardware4">A power outlet for the micro controller and sensor</li>
                <li data-i18n="components.hardware5">Electrical PVC conduit (optional)</li>
                <li>
                  <a
                    href="https://www.printables.com/model/67422-jsn-sr04t-water-level-sensor-case"
                    target="_blank"
                    rel="noopener noreferrer"
                    data-i18n="components.hardware6"
                    >3D printed sensor fitting (optional)</a
                  >
                </li>
              </ul>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_3D_printed_sensor_fitting.png"
                  alt="3D Printed sensor fitting"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="components.imageCaption">3D Printed sensor fitting</p>
              </div>

              <h4 data-i18n="components.softwareHeading">Software:</h4>
              <ul>
                <li data-i18n="components.software1">A WiFi connection</li>
                <li>
                  <a
                    href="https://randomnerdtutorials.com/how-to-install-esp8266-board-arduino-ide/"
                    target="_blank"
                    rel="noopener noreferrer"
                    data-i18n="components.software2"
                    >ESP8266 board</a
                  >
                </li>
                <li>
                  <a
                    href="https://www.arduino.cc/reference/en/libraries/espmqttclient/"
                    target="_blank"
                    rel="noopener noreferrer"
                    data-i18n="components.software3"
                    >EspMQTTClient.h Arduino library</a
                  >
                </li>
                <li>
                  <a
                    href="https://nodered.org/"
                    target="_blank"
                    rel="noopener noreferrer"
                    data-i18n="components.software4"
                    >Node-RED</a
                  >
                </li>
                <li>
                  <a
                    href="https://mosquitto.org/"
                    target="_blank"
                    rel="noopener noreferrer"
                    data-i18n="components.software5"
                    >Mosquitto MQTT</a
                  >
                </li>
                <li>
                  <a
                    href="https://www.influxdata.com/"
                    target="_blank"
                    rel="noopener noreferrer"
                    data-i18n="components.software6"
                    >InfluxDB</a
                  >
                </li>
              </ul>

              <p data-i18n="components.paragraph1">
                I chose the JSN-SR04T sensor because it's waterproof and can
                provide an accurate range up to 4 meters. It requires 3V to work
                so it can be powered directly by the ESP32 micro controller.
              </p>
              <p data-i18n="components.paragraph2">
                For the setup to work, the ESP32 must be in range of your Wi-Fi
                network. This way it can send the data from the sensor to the
                Raspberry-Pi. Also, both the ESP32 and the Raspberry Pi need to
                be in the same local area network.
              </p>
              <p data-i18n="components.paragraph3">
                You can use either an ESP32 or an ESP8266 micro controller. Both
                will work and both are set up in exactly the same way.
              </p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- How to build -->
            <div class="blog-section" id="build-sensor">
              <h3 data-i18n="buildSensor.heading">How to build the water level sensor</h3>

              <h4 data-i18n="buildSensor.connectionsHeading">Connections</h4>
              <p data-i18n="buildSensor.paragraph1">
                To set up the sensor simply connect the wires following the
                electrical diagram below:
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_diagram_002.png"
                  alt="Electrical connections diagram"
                  class="image fit"
                  style="padding: 1rem"
                />
                <p class="image-caption" data-i18n="buildSensor.imageCaption1">Electrical connections diagram</p>
              </div>

              <h4 data-i18n="buildSensor.outdoorHeading">Outdoor housing</h4>
              <p data-i18n="buildSensor.paragraph2">
                Since this is an outdoor setup, place the cables inside an
                electrical conduit to protect them from the rain and the sun.
              </p>
              <p data-i18n="buildSensor.paragraph3">
                You will also need to make sure to place an electrical outlet
                nearby to power the ESP32 and the sensor.
              </p>
              <p data-i18n="buildSensor.paragraph4">
                To protect the ESP32, part of the ultrasonic sensor and the
                power outlet, house everything inside a waterproof electrical
                box attached to a wall.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_electrical_box_label.png"
                  alt="Waterproof electrical box"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="buildSensor.imageCaption2">Waterproof electrical box setup</p>
              </div>

              <p data-i18n="buildSensor.paragraph5">
                Inside the electrical box, fix the ESP32 and part of the sensor
                using Din rails to keep it in place.
              </p>
              <p>
                <span data-i18n="buildSensor.paragraph6">To make an exact adapter, you can buy Din rail mounts or get the
                3D printed files and make your own from</span>
                <a
                  href="https://www.thingiverse.com/thing:4754669"
                  target="_blank"
                  rel="noopener noreferrer"
                  data-i18n="buildSensor.here"
                  >here</a
                >.
              </p>
              <p data-i18n="buildSensor.paragraph7">
                To set up the sensor, drill a hole at the top of the water tank.
                The sensor has silicone pressure fittings that should keep it
                fixed in place.
              </p>
              <p>
                <span data-i18n="buildSensor.paragraph8">You can make a</span>
                <a
                  href="https://www.printables.com/model/67422-jsn-sr04t-water-level-sensor-case"
                  target="_blank"
                  rel="noopener noreferrer"
                  data-i18n="buildSensor.link3dPrinted"
                  >3d printed water tank adapter</a
                >
                <span data-i18n="buildSensor.paragraph9">to make sure the sensor cable is protected from the elements.</span>
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_detail.png"
                  alt="Sensor attached to lid with 3D printed fitting"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="buildSensor.imageCaption3">Sensor installation detail</p>
              </div>

              <h4 data-i18n="buildSensor.measurementsHeading">Measurements used</h4>
              <p data-i18n="buildSensor.paragraph10">
                Now we must take the measurements of the water tank to calculate
                its maximum water volume.
              </p>
              <p data-i18n="buildSensor.paragraph11">
                This particular water tank can be separated into two different
                shapes: A cylinder and a cone with its top cut off (called a
                frustum cone).
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_tank_measurements.png"
                  alt="Water tank measurements"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="buildSensor.imageCaption4">Water tank measurements</p>
              </div>

              <p data-i18n="buildSensor.paragraph12">The formulas to calculate the volume of both shapes are:</p>

              <div class="row gtr-150">
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="images/water-level-monitor/water_level_cylinder_formula.png"
                      alt="Formula for calculating cylinder volume"
                      class="image fit"
                    />
                    <p class="image-caption" data-i18n="buildSensor.imageCaption5">Cylinder volume formula</p>
                  </div>
                </div>
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="images/water-level-monitor/water_level_frustum_formula-e1668063602234.jpg"
                      alt="Formula for calculating frustum volume"
                      class="image fit"
                    />
                    <p class="image-caption" data-i18n="buildSensor.imageCaption6">Frustum volume formula</p>
                  </div>
                </div>
              </div>

              <p data-i18n="buildSensor.paragraph13">
                Using both formulas, we can calculate the volume for the water
                tank in the following way:
              </p>
              <ul>
                <li data-i18n="buildSensor.volume1">Cylinder volume: 998 Liters</li>
                <li data-i18n="buildSensor.volume2">Frustum volume: 119 Liters</li>
                <li data-i18n="buildSensor.volume3">Total volume: 1,117 Liters</li>
              </ul>
              <p data-i18n="buildSensor.paragraph14">
                In this case, there were two identical water tanks, so we
                doubled the amount to get the maximum total water volume.
              </p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Reading data -->
            <div class="blog-section" id="reading-data">
              <h3 data-i18n="readingData.heading">Reading the water level sensor data</h3>
              <p data-i18n="readingData.paragraph1">
                After taking the measurements of the water tank and calculating
                its volume, we can use the sensor to calculate the height from
                the top of the water tank to the water line and then subtract
                that height from the frustum and cylinder formulas.
              </p>
              <p>
                <span data-i18n="readingData.paragraph2">To calculate the distance from the sensor to the water line we
                used this</span> <a href="#code" class="blog-link" data-i18n="readingData.codeLink">code</a> <span data-i18n="readingData.paragraph3">and
                uploaded it to the ESP32.</span>
              </p>
              <p data-i18n="readingData.paragraph4">
                The code reads the JSN-SR04T sensor data and sends it through
                MQTT to the Raspberry Pi.
              </p>
              <p data-i18n="readingData.paragraph5">
                Once uploaded, open the Arduino serial monitor to make sure it
                was working correctly.
              </p>
              <p data-i18n="readingData.paragraph6">
                Connect the Raspberry Pi and confirm that the Mosquitto MQTT
                Broker is receiving the values that the ESP32 is reporting.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_setup3.png"
                  alt="Image of the water level monitor"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="readingData.imageCaption">Complete water level monitor setup</p>
              </div>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Saving data -->
            <div class="blog-section" id="saving-data">
              <h3 data-i18n="savingData.heading">Saving the values to a database</h3>
              <p data-i18n="savingData.paragraph1">
                After confirming that MQTT is working correctly, we need to
                configure Node-RED to read the MQTT data, save it as as JSON
                object and then write it to a Influx DB database which was
                previously set up.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_NodeRed.png"
                  alt="Node-RED setup in Raspberry Pi"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="savingData.imageCaption">Node-RED setup in Raspberry Pi</p>
              </div>

              <ul>
                <li data-i18n="savingData.bullet1">The 'Water Level' node reads the MQTT message.</li>
                <li data-i18n="savingData.bullet2">
                  The 'Water Level Calculation' node calculates the water volume
                  taking into account the distance to the waterline.
                </li>
                <li data-i18n="savingData.bullet3">
                  The 'Database Storage' reads the volume variable every 5
                  minutes.
                </li>
                <li data-i18n="savingData.bullet4">
                  The 'Prepare InfluxDB Payload' node adds the date and time,
                  and saves the output as a JSON object.
                </li>
                <li data-i18n="savingData.bullet5">
                  The 'NivelTinaco_Agua' node saves the information to Influx DB
                  in a database with the same name.
                </li>
                <li data-i18n="savingData.bullet6">Green nodes are used for debugging and testing.</li>
              </ul>

              <p data-i18n="savingData.paragraph2">
                The rest of the nodes are configured through the node menu in
                Node-RED and don't need any code.
              </p>
              <p data-i18n="savingData.paragraph3">
                To check that the data was accessible, log into the Influx DB
                database using the terminal and take a look at the values.
              </p>

              <div class="image-container">
                <img
                  src="images/water-level-monitor/water_level_influxdb.png"
                  alt="InfluxDB database display"
                  class="image fit"
                />
                <p class="image-caption" data-i18n="savingData.imageCaption2">
                  InfluxDB database showing stored data
                </p>
              </div>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Visualizing data -->
            <div class="blog-section" id="visualizing">
              <h3 data-i18n="visualizing.heading">Visualizing the data</h3>
              <p data-i18n="visualizing.paragraph1">
                After making sure that the information is getting written into
                the influx DB database correctly, lets configure Grafana to
                visualize the data.
              </p>
              <p data-i18n="visualizing.paragraph2">
                Grafana is a great tool for data visualization because its open
                source, easy to use, and produces great dynamic charts.
              </p>
              <p data-i18n="visualizing.paragraph3">
                You can make a dashboard with a Gauge reading for the current
                water level and also a time series to display the water values
                over a 24-hour period.
              </p>

              <div class="row gtr-150">
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="images/water-level-monitor/water_level_gauge_002.png"
                      alt="Gauge to display current water amount"
                      class="image fit"
                    />
                    <p class="image-caption" data-i18n="visualizing.imageCaption1">Current water level gauge</p>
                  </div>
                </div>
                <div class="col-6 col-12-medium">
                  <div class="image-container">
                    <img
                      src="images/water-level-monitor/water_level_time_series_002.png"
                      alt="Time series showing water tank level"
                      class="image fit"
                    />
                    <p class="image-caption" data-i18n="visualizing.imageCaption2">24-hour water level time series</p>
                  </div>
                </div>
              </div>

              <p data-i18n="visualizing.paragraph4">
                In the graph you can see how the water level falls periodically
                (morning showers, washing clothes at midday) and is gradually
                restored over time.
              </p>
              <p data-i18n="visualizing.paragraph5">
                Water levels don't seem to fall below the 1,000L mark, but an
                alarm is set to send a telegram message if the water level falls
                below this threshold value.
              </p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Using data -->
            <div class="blog-section" id="using-data">
              <h3 data-i18n="usingData.heading">How to use the sensor data</h3>
              <p data-i18n="usingData.paragraph1">
                The sensor data is useful because it checks the water level
                every 5 minutes and sends an alarm if the level is too low.
              </p>
              <p data-i18n="usingData.paragraph2">
                It lets us know if there's a problem, which gives us time to fix
                it with enough water available for essential tasks.
              </p>
              <p data-i18n="usingData.paragraph3">
                It is also a useful sensor because it allows us to check the
                daily water consumption and how that trend changes over time.
              </p>
              <p data-i18n="usingData.paragraph4">
                Measuring is the first step towards efficiency and a more
                sustainable future.
              </p>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- More resources -->
            <div class="blog-section" id="resources">
              <h3 data-i18n="resources.heading">More resources</h3>
              <p data-i18n="resources.paragraph1">
                I hope you found this post interesting. Building the water
                sensor was a fun and rewarding project, and I've found it to be
                a very useful project.
              </p>
              <p data-i18n="resources.paragraph2">
                If you decide to build a similar water level monitoring setup, I
                encourage you to get creative and see how you can customize it
                to fit your specific needs. There are many possible variations
                and improvements you could make, like integrating it with smart
                home systems or expanding the sensor network to multiple tanks.
                The key is to start small, experiment, and don't be afraid to
                troubleshoot when things don't work as expected.
              </p>
              <p data-i18n="resources.paragraph3">
                Feel free to contact me if you decide to build one and you need
                any help.
              </p>
              <p>
                <span data-i18n="resources.paragraph4">I also made IoT Energy Monitor. You can find the post about that</span>
                <a
                  href="https://blog.pablocruz.io/iot-energy-monitor/"
                  target="_blank"
                  rel="noopener noreferrer"
                  data-i18n="resources.here"
                  >here</a
                >.
              </p>

              <p data-i18n="resources.paragraph5">
                Finally, here are some additional resources that I used to make this project possible:
              </p>

              <div class="video-resources">
                <div class="row gtr-150">
                  <div class="col-4 col-12-medium">
                    <div class="video-container">
                      <a href="https://www.youtube.com/watch?v=h6321UBATps" target="_blank" rel="noopener noreferrer">
                        <img src="https://img.youtube.com/vi/h6321UBATps/maxresdefault.jpg" alt="YouTube Video Thumbnail" class="video-thumbnail" />
                        <div class="play-button">▶</div>
                      </a>
                    </div>
                  </div>
                  <div class="col-4 col-12-medium">
                    <div class="video-container">
                      <a href="https://www.youtube.com/watch?v=KawRd5evHyY" target="_blank" rel="noopener noreferrer">
                        <img src="https://img.youtube.com/vi/KawRd5evHyY/maxresdefault.jpg" alt="YouTube Video Thumbnail" class="video-thumbnail" />
                        <div class="play-button">▶</div>
                      </a>
                    </div>
                  </div>
                  <div class="col-4 col-12-medium">
                    <div class="video-container">
                      <a href="https://www.youtube.com/watch?v=7M8MHa6W9w0" target="_blank" rel="noopener noreferrer">
                        <img src="https://img.youtube.com/vi/7M8MHa6W9w0/maxresdefault.jpg" alt="YouTube Video Thumbnail" class="video-thumbnail" />
                        <div class="play-button">▶</div>
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  title="Back to table of contents"
                ></a>
              </div>
            </div>

            <div class="section-separator"></div>

            <!-- Code section -->
            <div class="blog-section" id="code">
              <h3 data-i18n="code.heading">Code</h3>

              <h4 data-i18n="code.arduinoHeading">Arduino code uploaded to the ESP32:</h4>
              <pre class="code-block">
                <div class="code-header">
                  <span data-i18n="code.cppLabel">C++ (Arduino)</span>
                  <button class="copy-button" onclick="copyCode(this)" data-i18n="code.copyButton">Copy</button>
                </div>
                <code class="language-cpp">// Code to measure water level in a water tank

// Mills Function 
const unsigned long event_interval = 300000; // 5 minute interval, 300 second
//const unsigned long event_interval = 2000; // 2 second interval. For testing
unsigned long previous_time = 0; 

// MQTT Library
#include "EspMQTTClient.h" 

#define WIFI_SSID        "&lt;Wifi_Username_here&gt;"                          // WiFi Username
#define WIFI_PASS        "&lt;Wifi_Password_here&gt;"                          // Wifi Password

#define BROKER_IP        "&lt;MQTT_ip_here&gt;"                                // IP address of MQTT broker
#define BROKER_USERNAME  "&lt;broker_username_here&gt;"                        // Broker username
#define BROKER_PASSWORD  "&lt;broker_password_here&gt;"                        // Broker password
#define CLIENT_NAME      "&lt;device_name_here&gt;"                            // MQTT client name to identify the device
#define BROKER_PORT      &lt;mqtt_port_here&gt;                                // MQTT Port. No "" needed
#define lastwill_topic   "&lt;lastwill_topic_here&gt;"                         // MQTT topic to report last-will and testament.
#define lastwill_text    "&lt;lastwill_message_here&gt;"                       // MQTT message to report last-will and testament.

String  client_name       = CLIENT_NAME;                                 // MQTT Topic to report initial value
String  startup_topic     = "&lt;startup_topic_here&gt;";                      // MQTT Topic to report startup
String  water_level_topic = "&lt;reporting_values_topic_here&gt;";             // MQTT topic to report values

// Function to connect to MQTT 
EspMQTTClient client(
                  WIFI_SSID,
                  WIFI_PASS,
                  BROKER_IP,
                  BROKER_USERNAME,
                  BROKER_PASSWORD,
                  CLIENT_NAME,
                  BROKER_PORT
                  );

// Water Sensor pins
#define TRIG 14 //GPIO Number 14, D5
#define ECHO 12 //GPIO Number 12, D6

void setup() { 
  
  Serial.begin(115200); // Serial monitoring 
  
  // Enable  debugging messages sent to serial output
  client.enableDebuggingMessages(); 

  // Enable the web updater.
  client.enableHTTPWebUpdater();     
  
  // MQTT Last Will & Testament
  client.enableLastWillMessage( lastwill_topic , lastwill_text);
  
  // Water level sensor Pin Setup
  pinMode(TRIG, OUTPUT);       // Initializing Trigger Output
  pinMode(ECHO, INPUT_PULLUP); // Initializing Echo Input
  } 

// MQTT Initial Connection
void onConnectionEstablished() {
  client.publish(startup_topic, String(client_name + " is now online."));
  }
  
  void loop() { 

    // MQTT Loop: Must be called once per loop.
    client.loop(); 

    // Mills Loop
    unsigned long current_time = millis();

    // Mills if Statement
    if(current_time - previous_time &gt;= event_interval) {
      // Set the trigger pin to low for 2uS 
      digitalWrite(TRIG, LOW); 
      delayMicroseconds(2); 

      // Send a 20uS high to trigger ranging
      digitalWrite(TRIG, HIGH);  
      delayMicroseconds(20); 

      // Send pin low again
      digitalWrite(TRIG, LOW);  

      // Read pulse times
      int distance = pulseIn(ECHO, HIGH,26000);  

      //Convert the pulse duration to distance
      distance= distance/58; 

      //Print Result in serial monitor
      Serial.print("Distance ");
      Serial.print(distance);
      Serial.println("cm");

      // MQTT Client Publisher
      client.publish(water_level_topic, String(distance));

      // Mills Update timing for next time
      previous_time = current_time;
    }
    
}</code></pre>

              <h4 data-i18n="code.nodeRedHeading">Node-RED Code used:</h4>

              <h5 data-i18n="code.waterLevelCalc">Water Level Calculation node:</h5>
              <pre class="code-block">
                <div class="code-header">
                  <span data-i18n="code.jsLabel">JavaScript (Node-RED)</span>
                  <button class="copy-button" onclick="copyCode(this)" data-i18n="code.copyButton">Copy</button>
                </div>
                <code class="language-javascript">// Code to calculate the available water in the water tank.
// Used in node: 'Water Level Calculation'

// Get sensor distance in meters
msg.payload = Number(msg.payload)/100;
sensor_distance = msg.payload;

// Constants
var pi = 3.141592;
var Liters = 0;
var VolumeFullCylinder = 998;

// Function to calculate water in Frustum
function FrustumVolume(x) {
    height = 0.35 - x
    FrustumWaterVolume = (pi/3)*height*(0.55**2 + 0.275**2 + 0.55*0.275)
    return FrustumWaterVolume*1000
  }

// Function to calculate water in Cylinder
function CylinderVolume(x) {
    height = 1.05 - x + 0.35
    CylinderWaterVolume = pi * 0.55**2 * height
    return CylinderWaterVolume*1000
  }

// Test to check total water volume
if (sensor_distance &lt; 0.20) {
    Message = "Error: Value is too low. Check Sensor";
    Liters = 0;
    msg.payload = Liters

  } else if (sensor_distance &gt;= 0.20 &amp;&amp; sensor_distance &lt;= 0.35) {
    Message = "Water is in Frustum.";
    Liters = FrustumVolume(sensor_distance)+ VolumeFullCylinder;
    Liters = Math.round(Liters*2) // Multiply x 2 because there are 2 water tanks
    msg.payload = Liters

  } else if (sensor_distance &gt; 0.35 &amp;&amp; sensor_distance &lt;= 1.40) {
    Message = "Water is in the cylinder section.";
    Liters = CylinderVolume(sensor_distance);
    Liters = Math.round(Liters*2) // Multiply x 2 because there are 2 water tanks
    msg.payload = Liters

  } else {
    Message = "Error: Value is to high. Check Sensor";
    Liters = 9999;
    msg.payload = Liters
  }

// Prepare node to send information
msg.payload = Number(msg.payload); 
flow.set("water_in_tank",msg.payload);
flow.set("water_level_sensor","ESP32");
return {payload: msg.payload};</code></pre>

              <h5 data-i18n="code.influxPayload">Prepare InfluxDB Payload node:</h5>
              <pre class="code-block">
                <div class="code-header">
                  <span data-i18n="code.jsLabel">JavaScript (Node-RED)</span>
                  <button class="copy-button" onclick="copyCode(this)" data-i18n="code.copyButton">Copy</button>
                </div>
                <code class="language-javascript">// Code to prepare water level data to save it into InfluxDB
// Used in node: 'Prepare InfluxDB Payload'

var today = new Date();

var date = today.getFullYear()+
            '-'+ (today.getMonth()+1)+
            '-'+ today.getDate() + 
            ' ' + today.getHours() + 
            ":" + today.getMinutes() + 
            ":" + today.getSeconds();

msg.payload = { 
    Timestamp:date, 
    Device:flow.get("water_level_sensor"), 
    Water_Level_In_Tank:flow.get("water_in_tank"),
}

return msg;</code></pre>
              <div style="text-align: center">
                <a
                  href="#blog-content"
                  class="back-to-top"
                  data-i18n-title="navigation.backToTop"
                ></a>
              </div>
            </div>
          </article>
        </div>
      </section>
      <!-- Blog Content End -->

      <!-- Navigation Section -->
      <section id="navigation" class="main style1">
        <div class="container">
          <article>
            <div class="blog-navigation">
              <div class="nav-links">
                <div class="nav-left">
                  <a href="index.html" class="button white-text" data-i18n="navigation.backToPortfolio"
                    >← Back to Portfolio</a
                  >
                </div>
                <div class="nav-right">
                  <a
                    href="https://github.com/portfedh/WaterLevelSensorMQTT"
                    class="button white-text"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <i class="fab fa-github"></i> <span data-i18n="navigation.viewGithub">View on GitHub</span>
                  </a>
                </div>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- Contact Start-->
      <section id="contact-section" class="main style2 special">
        <div class="container">
          <article>
            <header class="major fade-out">
              <h2 data-i18n="contact.heading">Get in touch!</h2>
            </header>
            <p class="fade-out">
              <span data-i18n="contact.paragraph1">I'm currently open to work and I'd be happy to chat.</span>
              <br />
              <br />
              <span data-i18n="contact.paragraph2">Feel free to reach out if you are interested in what I can bring
              to your project or team.</span>
            </p>
            <ul class="actions special">
              <li>
                <a
                  href="mailto:pablo.cruz.lemini@gmail.com"
                  class="button wide primary fade-out"
                  data-i18n="contact.emailButton"
                  >Email me</a
                >
              </li>
            </ul>
          </article>
        </div>
      </section>
      <!-- Contact End-->
    </main>
    <!-- Main Content End -->

    <!-- Footer Start -->
    <footer id="footer">
      <ul class="icons">
        <li>
          <a
            href="https://twitter.com/Portfedh"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Twitter Profile"
            ><i class="fa-brands fa-twitter"></i><span class="label">Twitter</span></a
          >
        </li>
        <li>
          <a
            href="https://www.linkedin.com/in/pablo-cruz-cdmx/"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="LinkedIn Profile"
            ><i class="fa-brands fa-linkedin"></i><span class="label">LinkedIn</span></a
          >
        </li>
        <li>
          <a
            href="https://github.com/portfedh"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="GitHub Profile"
            ><i class="fa-brands fa-github"></i><span class="label">GitHub</span></a
          >
        </li>
        <li>
          <a
            href="mailto:pablo.cruz.lemini@gmail.com"
            aria-label="Email link"
            ><i class="fa-solid fa-envelope"></i><span class="label">Email</span></a
          >
        </li>
      </ul>
      <ul class="copyright">
        <li>
          &copy;
          <script>
            document.write(new Date().getFullYear());
          </script>
          Pablo Cruz.
        </li>
      </ul>
    </footer>
    <!-- Footer End -->

    <!-- Scripts -->
    <script src="assets/js/blog-i18n.js"></script>
    <script>
      const blogI18n = new BlogI18n('water-level-monitor');
      blogI18n.init();
    </script>
    <script src="assets/js/main.js"></script>
    <script
      src="https://kit.fontawesome.com/1450436a40.js"
      crossorigin="anonymous"
    ></script>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Blog functionality -->
    <script src="assets/js/blog.js"></script>
  </body>
</html>
